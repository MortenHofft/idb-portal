{% extends "base.html" %} 

{% block headblock %}
<link rel="stylesheet" type="text/css" href="/portal/components/leaflet/dist/leaflet.css" />
<link rel="stylesheet" type="text/css" href="/portal/components/jquery-ui/themes/base/jquery.ui.core.css" />
<link rel="stylesheet" type="text/css" href="/portal/components/jquery-ui/themes/base/jquery.ui.datepicker.css" />
<link rel="stylesheet" type="text/css" href="/portal/components/jquery-ui-bootstrap/jquery.ui.theme.css" />
<link rel="stylesheet" type="text/css" href="/portal/components/markercluster/dist/MarkerCluster.Default.css" />
<link rel="stylesheet" type="text/css" href="/portal/css/app/search.css">
<meta property="og:site_name" content="iDigBio Specimen Portal" />
<meta property="og:title" content="iDigBio Specimen Search" />
<meta property="og:image" content="https://www.idigbio.org/sites/default/files/sites/default/files/idigbio_og.png" />
<meta property="og:description" content="The iDigBio Portal Specimen Search provides the ability to search millions of digitized natural history records from across the U.S.." />
<meta property="og:type" content="website" />
<meta property="og:url" content="{{user.protocol}}://{{ user.host }}/portal/search" />

{% endblock %} 

{% block content %}
<div id="main" class="container-fluid" style="margin:0px;"></div>
{% endblock %} 

{% block appblock %}

<script type="text/template" class="frame">
    <div id="record-view"></div>
    <div id="bgmodal"></div>
    <div class="row-fluid">
        <div class="span12">

            <div id="search-and-info" class="clearfix">
                <div id="search-box" class="clearfix pull-left">
                    <div class="clearfix">
                        <h3 class="pull-left" style="font-size:1.7em;"><img src="/portal/img/arrow-green.png" style="width:35px;margin:0px 10px 5px 0px;">Search Records</h3>
                    </div>
                    <div id="fulltext-search" class="clearfix well-small">
                        <div id="search-frame" class="clearfix"></div>
                    </div>
                </div>
                <div id="stats-and-download" class="clearfix pull-left">
                    <h4>Current Results</h4>          
                    <ul id="stats-frame"></ul>
                </div>

                <div class="pull-left clearfix" id="map-box">
                    <div class="pull-left clearfix" id="results-map"></div>
                </div> 

            </div>
            <hr>

            <div id="advanced-search" class="clearfix well well-small">
                <h5 id="advanced-search-header">Advanced Search</h5>
                <form id="fieldform" class="form sortable">
            
                    <div style="width:100%">
                        <div class="clearfix term-inputs" id="term-inputs-main"></div>
                        <div id="search-controls" class="clearfix">
                            <div class="sort-control clearfix pull-left">
                                <div class="clearfix name">Add a field</div>
                                <select id="control-select" class="controls">
                                    <option value="0">please select</option>
                                </select>
                            </div>
                            <div class="clearfix pull-left sort-control">
                                <div class="clearfix name">Sort by</div>
                                <div class="controls" id="must-have-controls">
                                     <select class="input search-input" id="sort-by" name="sortName" style="width:198px;">
                                        <option value="scientificname">Scientific Name</option>
                                        <option value="genus">Genus</option>
                                        <option value="family">Family</option>
                                        <option value="country">Country</option>
                                        <option value="stateprovince">State/Province</option>
                                        <option value="institutioncode">Institution Code</option>
                                     </select>
                                </div>
                            </div>
                            <div class="clearfix pull-left sort-control">
                                <div class="clearfix name">Direction</div>
                                <div class="controls" id="must-have-controls">
                                     <select class="input-medium search-input" id="sort-by-dir" name="sortDir">
                                        <option value="asc">Ascending</option>
                                        <option value="desc">Descending</option>
                                     </select>
                                </div>
                            </div>
                            <div  class="clearfix pull-left" id="search-control">
                                <div class="controls">
                                       <button id="advanced-search-button" class="search-button clearfix">Search</button>
                                        <div class="input-append" style="margin-bottom:0px;">
                                            <button id="clear-button" class="clearfix">Clear</button>
                                            <button id="reset-button" class="clearfix">Reset</button>
                                        </div>                           
                                </div>
                                <div style="text-align:center;margin-top:5px;"><a id="help-button" href="#">Tips & Hints</a></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div id="help" class="modal hide">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4>Advanced search hints</h4>
            </div>
            <div class="modal-body">
                <ul>
                    <li>All fields correspond to <a target="new" href="http://rs.tdwg.org/dwc/terms/index.htm">Darwin Core</a> terms.</li>
                    <li>Use a new line for multiple terms in a single field.</li>
                    <li>Terms are evaluated as an exact match.</li>
                    <li>Use the <img src="/portal/img/move.png"> icon or field name to drag and sort the term boxes.</li>
                    <li>Table view columns are determined by the order of the first 7 term boxes or the default terms if there are less then 7 on screen.</li>
                    <li>Present and Missing options refer to the presence or absence of data in the record.</li>
                    <li>The <em>Scientific Name</em>, <em>Genus</em> and <em>Specific Epithet</em> fields are all separate fields within our records.
                        Searching on Scientific Name will not search on the Genus and Specific Epithet fields or vice versa. Searching on these fields will
                        be improved with the next release of the iDigBio portal.
                    </li>
                    <li>Sorting on Genus will also apply the sort logic to Specifc Epithet and vice versa.</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button class="btn btn-info" data-dismiss="modal" aria-hidden="true">close</button>
            </div>
        </div>
    </div>
    <div class="row-fluid">
        <div id="results-section" class="span12">

        </div>
    </div>  
</script>

<script type="text/template" id="results-template">
    <div id="results-sorter"></div>
    <div class="row-fluid">
        <ul class="nav nav-tabs clearfix" id="view-nav">
            <li class="active" id="table-view" data-name="table"><a href="#">Table view</a>
            </li>
            <li id="labels-view" data-name="labels"><a href="#">Label view</a>
            </li>
            <li id="images-view" data-name="images"><a href="#">Images</a></li>
            <li> &nbsp;&nbsp;</li>
            <li class="pull-right"><span id="search-stats">No Search Results</span></li>
        </ul>
    </div>
    <div class="row-fluid clearfix" id="results-pane">
        <div class="clearfix" id="results" style="margin:0px;"></div>
    </div>
    <div class="row-fluid">
        <div class="span12" style="text-align:center;">
            <img id="more-loading-spinner" src="/portal/img/ajax-loader.gif" alt="..loading more results" style="display:none;"/>
            <button id="more-button" style="display:none" class="btn btn-xlarge btn-success">More Results</button>
        </div>
    </div>
</script>

<script type="text/template" id="search-frame-template"> 
    <div class="control-div">
        <div style="width:280px" class="clearfix">
            <span class="clearfix pull-left">Full Text Search</span>                                     
        </div>
    </div>
    <div class="input-append" style="margin-bottom:5px;margin-top:3px;">
        <input  class="search-input" id="full-text-search" type="text" name="fulltext">
        <button class="search-button" type="submit" id="fulltext-button">Search</button>
    </div>
    <div style="margin-top:5px;">
        <span class="pull-left images-only" style="margin-right:13px;">                                       
                <label class="checkbox" style="margin:0px;font-size:12px;">
                    <input class="search-input" id="images-only" type="checkbox" name="hasImage">only records with images
                </label>
        </span><a id="form-toggle" href="#" >Hide Advanced Search</a>
    </div>
</script>

<script type="text/template" id="stats-frame-template">
    <li style="padding:0px;margin:0px;">
        <div class="input-prepend input-append">
            <span class="add-on">Query:</span>
            <select class="input input-medium" id="query-select"></select>
            <button class="" title="clear history" id="clear-history">Clear</button>
        </div>
    </li>
    <li class="stats-info" style="margin:0px;padding:0px;">Records:&nbsp;&nbsp;<span id="total-matches-text"></span></li>
    <li class="stats-info" style="margin:0px;padding:0px;">
        <div id="download" class="clearfix">
            <div id="download-frame" class="clearfix">
                <div class="control-div">
                    <div style="width:280px" class="clearfix">
                        <span id="time" class="clearfix pull-left">Approx. Download Time: <span id="time-estimate"></span></span>                                     
                    </div>
                </div>            
                <div class="input-prepend input-append" style="padding:0px;margin:0px;">
                    <span class="add-on">Email:</span>
                    <input class="input-medium" id="download-email" type="email" placeholder="Enter Email to Download" required>
                    <button class="download-button" type="submit" id="download-button">Download</button>
                </div>
            </div>
        </div>
    </li>
    <li id="info-spinner" style="display:none;width:130px;text-align:center;padding-top:10px;"><img src="/portal/img/ajax-loader.gif"></li>
</script>

<script type="text/template" id="label-template">
    <div id="<%= data.uuid %>" class="pull-left result-item result-label" title="click to view record">
        <p>
        <% var raw = data.data['idigbio:data']; %>
        <% if( data.hasImage ){ %>
            <span class="label-image-holder">
               <% if(data.mediarecords.length > 1){ %>
                    <span class="label-image-count">
                        <%= data.mediarecords.length %>
                    </span>
               <% } %>
            <img onerror="$(this).attr('src','/portal/img/notavailable.png')" onload="$(this).attr('alt','image thumbnail')" class="pull-right label-image img-rounded" alt=" loading image..." src="https://api.idigbio.org/v1/records/<%= data.uuid %>/media?quality=thumbnail" > 
            </span>       
        <% } %>
            <span style="line-height:1em;font-size:1em;">
        <% 
            var txt = '';
            if(typeof data.scientificname == 'string') { 
                txt += helpers.check(raw["dwc:scientificName"]) + helpers.check(raw["dwc:scientificNameAuthorship"]);
        %>           
                <em><b><%= helpers.check(raw["dwc:scientificName"]) %></b></em><%= helpers.check(raw["dwc:scientificNameAuthorship"], ' ') %>&#44;           
        <%  
            } else {  
                txt += helpers.check(raw["dwc:genus"]) + helpers.check(raw["dwc:specificEpithet"]) + helpers.check(raw["dwc:scientificNameAuthorship"]);
        %>
                <em><b><%= helpers.check(raw["dwc:genus"]) + helpers.check(raw["dwc:specificEpithet"],' ') %></b></em><%= helpers.check(raw["dwc:scientificNameAuthorship"], ' ') %>&#44;
        <%  
            } 
        %>
            </span>     
        <%            
   
        var terms = ['kingdom','phylum','class','order','family','country', 'stateprovince','locality','collector','fieldnumber','datecollected','institutioncode','collectioncode'];

            var para = []
            _.each(terms,function(term){
                if(helpers.check(raw[fields.byTerm[term].dataterm]) !== ''){
                    if(term === 'datecollected'){
                        para.push(raw[fields.byTerm[term].dataterm].substring(0,10));
                    }else{
                        para.push(raw[fields.byTerm[term].dataterm])
                    }
                }
            })
            var clean = para.filter(function(i){
                return !_.isEmpty(i);
            });
            var out = clean.join(', ');
            if ((txt+out).length > 255) {
                out = out.substring(0, out.length-txt.length);// + ' ...';
            }
        %>
        <%= out %>

        </p>
    </div>
</script>

<script type="text/template" id="control-template-frame">
    <div class="clearfix pull-left search-control" data-name="<%= name %>" data-term="<%= term %>">
        <div class="clearfix">
            <div title="click and hold term name to drag" class="control-div pull-left name-div">
                <img src="/portal/img/move.png" alt="move"> <%= name %>
            </div>
            <button type="button" class="close" data-dismiss="modal" data-name="<%= name %>" aria-hidden="true">&times;</button>
        </div>
        <div class="controls clearfix">
                <%= partial %>
        </div>
    </div>
</script>

<script type="text/template" id="control-template-text">
    <textarea class="text-term search-input" type="text" placeholder="<%= obj.dataterm %>" data-name="<%= obj.term %>" name="<%= obj.term %>-text" rows="2"></textarea>
    <div class="bool-check check-label">
        <label class="checkbox pull-left">
            <input class="search-input" type="checkbox" data-name="<%= obj.term %>" name="<%= obj.term %>-checkbox" value="exists">&nbsp;Present
        </label>
        <label class="checkbox" style="margin-left:100px;">
            <input class="search-input" type="checkbox" data-name="<%= obj.term %>" name="<%= obj.term %>-checkbox" value="missing">&nbsp;Missing
        </label>
    </div>
</script>

<script type="text/template" id="control-template-text-sn">
    <textarea class="text-term search-input" type="text" placeholder="<%= obj.dataterm %>" data-name="<%= obj.term %>" name="<%= obj.term %>-text" rows="2"></textarea>
    <button data-name="<%= obj.term %>" class="syn-button">
        Add Synonyms
        <img src="/img/ajax-loader.gif" class="syn-loader">
    </button>
    <div class="bool-check check-label">
        <label class="checkbox pull-left" style="margin-left:50px">
            <input class="search-input" type="checkbox" data-name="<%= obj.term %>" name="<%= obj.term %>-checkbox" value="exists">&nbsp;Present
        </label>
        <label class="checkbox" style="margin-left:150px;">
            <input class="search-input" type="checkbox" data-name="<%= obj.term %>" name="<%= obj.term %>-checkbox" value="missing">&nbsp;Missing
        </label>
    </div>
</script>

<script type="text/template" id="control-template-absolute">
    <div class="bool-check check-label">
        <label class="checkbox pull-left"><input class="search-input" type="checkbox" name="<%= obj["term"] %>" value="exists">&nbsp;Present</label>
        <label class="checkbox" style="margin-left:100px;"><input class="search-input" type="checkbox" name="<%= obj["term"] %>" value="missing">&nbsp;Missing</label>
    </div>
</script>

<script type="text/template" id="control-template-bool">
    <div style="margin:5px" class="pull-left">
        <label class="radio">
            True<input type="radio" name="<%= obj["term"] %>" value="true">&nbsp;
            False<input type="radio" name="<%= obj["term"] %>" value="false">
        </label>
    </div>
</script>

<script type="text/template" id="control-template-daterange">
    <div class="daterange clearfix">
        <div class="clearfix range-div">
            From: 
            <input type="text" placeholder="YYYY-MM-DD" data-name="<%= obj.term %>" data-operator="gte" name="<%= obj.term %>-gte-range" class="search-input datepicker">
        </div>
        <div class="clearfix range-div">
            To: 
            <input type="text" placeholder="YYYY-MM-DD" data-name="<%= obj.term %>" data-operator="lte" name="<%= obj.term %>-lte-range" class="search-input datepicker">
        </div>
    </div>
    <div class="bool-check check-label">
        <label class="checkbox pull-left">
            <input class="search-input" type="checkbox" data-name="<%= obj.term %>" name="<%= obj.term %>-checkbox" value="exists">&nbsp;Present
        </label>
        <label class="checkbox" style="margin-left:100px;">
            <input class="search-input" type="checkbox" data-name="<%= obj.term %>" name="<%= obj.term %>-checkbox" value="missing">&nbsp;Missing
        </label>
    </div>
</script>

<script type="text/template" id="control-template-geobounds">
    <div class="locbounds">
        <b>NorthWest:</b>
        Lat:<input placeholder="90.0" type="text" name="<%= obj.term %>-top_left-lat-geobounds" data-pos="top_left" data-loc="lat" class="search-input bounds-input">Lon:<input placeholder="-180.0" name="<%= obj.term %>-top_left-lon-geobounds" type="text" data-pos="top_left" data-loc="lon"  class="bounds-input search-input"><br>
        <b>SouthEast:</b>
        Lat:<input placeholder="-90.0" type="text" name="<%= obj.term %>-bottom_right-lat-geobounds" data-pos="bottom_right" data-loc="lat" class="search-input bounds-input">Lon:<input placeholder="180.0" name="<%= obj.term %>-bottom_right-lon-geobounds" type="text" data-pos="bottom_right" data-loc="lon" class="bounds-input search-input"><br>
    </div>
    <div class="bool-check check-label" style="margin-top:1px;">
        <label class="checkbox pull-left" style="margin-left:50px;">
            <input class="search-input" type="checkbox" data-name="<%= obj.term %>" name="<%= obj.term %>-checkbox" value="exists">&nbsp;Present
        </label>
        <label class="checkbox" style="margin-left:150px;">
            <input class="search-input" type="checkbox" data-name="<%= obj.term %>" name="<%= obj.term %>-checkbox" value="missing">&nbsp;Missing
        </label>
    </div>
</script>

<script type="text/template" id="control-template-locrange">
    <div class="locrange clearfix">
        <div style="margin:0px;" class="clearfix">
            <div class="clearfix range-div pull-right">
                From:
                <input data-operator="gte" name="<%= obj.term %>-gte-range" type="text" class="search-input"> in meters
            </div>
            <div class="clearfix range-div pull-right">
                To:
                <input data-operator="lte" name="<%= obj.term %>-lte-range" type="text" class="search-input"> in meters
            </div>
        </div>
    </div>
    <div class="bool-check check-label clearfix" style="margin-top:6px;">
        <label class="checkbox pull-left">
            <input class="search-input" type="checkbox" data-name="<%= obj.term %>" name="<%= obj.term %>-checkbox" value="exists">&nbsp;Present
        </label>
        <label class="checkbox" style="margin-left:100px;">
            <input class="search-input" type="checkbox" data-name="<%= obj.term %>" name="<%= obj.term %>-checkbox" value="missing">&nbsp;Missing
        </label>
    </div>    
</script>

<script type="text/template" id="record-template">
    <div id="<%= elid %>" class="record" style="width:<%= $(window).width()-40 %>px;height:<%= $(window).height()-40 %>px;">
        <span class="pull-right record-close" title="close record" onclick="overlay.remove('<%= cid %>');return false;">X</span>
        <h3>Specimen Record</h3>
        <div style="height:<%= $(window).height()-140 %>px;overflow-y:scroll;padding:10px;">
            
                <% _.each(fields.typeOrder, function(v){   %> 
                    <% var rendered = false %>
                    <% _.each(fields.orderByType[v], function(val){   %> 
                        <% if(!_.isUndefined(data[val])){ %>   
                            <%=  rendered === false ? '<legend>'+fields.typeNames[v]+'</legend>' : '' %> 
                            <%=  rendered === false ? '<table class="table table-striped table-bordered" style="overflow:hidden;">' : '' %> 
                            <%  var name = _.isUndefined(fields.byDataTerm[val]) ? val : fields.byDataTerm[val].name %>
                            <tr><td style="font-weight:bold;text-align:left;width:250px;"><%=  name %></td><td><%= data[val] %></td></tr>
                            <% rendered = true %>
                        <% } %>
                    <% }); %>
                    <%= rendered === true ? '</table>': '' %>
                    <% rendered = false %>
                <% }); %>
            
        </div>
    </div>
</script>

<script>L_PREFER_CANVAS = true;</script>
<script type="text/javascript" src="/portal/js/app.js"></script>
{% endblock %}
{% block scriptblock %} {% endblock %}
