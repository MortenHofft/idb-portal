{% extends "base.html" %} {% block headblock %}
<link rel="stylesheet" type="text/css" href="/portal/css/app/home.css">
<link rel="stylesheet" type="text/css" href="/portal/css/deprecated.css">
<meta property="og:site_name" content="iDigBio Specimen Portal" />
<meta property="og:title" content="iDigBio Portal Home" />
<meta property="og:image" content="https://www.idigbio.org/sites/default/files/sites/default/files/idigbio_og.png" />
<meta property="og:url" content="{{user.protocol}}://{{ user.host }}/portal" />
<meta property="og:description" content="The iDigBio Specimen Portal provides access to millions of digitized natural history records gathered from institutions across the United States." />
{% endblock %} {% block content %}
<div class="row-fluid" id="portal-home">
    <div class="span12" style="padding:10px 20px;" class="clearfix">
        <div style="margin:auto;float:left;" class="clearfix">
            <div  id="facets"  class="clearfix">
                <div class="pull-left" style="margin:15px 15px 15px 5px">
                    <div id="basicsearch">
                        
                        <h4>Start Searching Specimen Records</h4>
                        <div id="search" class="">
                            <p>Press ESC to close auto-complete suggestions. </p>
                            <div class="input-append">
                                <input type="text" placeholder="Scientific Name" class="input-large" id="searchbox" autocomplete="off">
                                <button type="submit" class="btn btn-success" id="search-button">Search</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="margin:15px 15px 15px 5px" class="pull-left">
                    <h3 style="color: #444;margin:0px 0px;padding-top:0px;">iDigBio Specimen Portal</h3>
                    <p>If you are familiar with our portal's interface, you can start searching <a href="/portal/search">Specimen Records</a>.<br>
                    If this is your first time here, you might consider browsing <a href="/portal/tutorial">our tutorial.</a><br>
                    Our data are based on the <a href="http://rs.tdwg.org/dwc/terms/index.htm">Darwin Core</a> and <a href="http://terms.gbif.org/wiki/Audubon_Core">Audubon Core</a> standards.</p>
                </div>
            </div>
            <div id="output">



                <br>
                <div id="graph-stats" style="border-top: #ccc 1px solid;border-bottom: #ccc 1px solid;" class="row-fluid">
                    <div class="span4" style="margin:0px;" id="specimen-graph">
                        <div style="width: 100%; text-align: center; font-weight: bold; font-size: 11px;">Specimen Records by Collection Type</div>
                        <div style="min-width: 200px; height: 280px; margin: 0 auto" id="record">
                        </div>
                    </div>
                    <div class="span4" style="margin:0px;" id="media-graph">
                        <div style="width: 100%; text-align: center; font-weight: bold; font-size: 11px;">Media Records by Collection Type</div>
                        <div style="min-width: 200px; height: 280px; margin: 0 auto" id="media"></div>
                    </div>

                    <div  id="stats" class="span4">
                        <div style="margin:60px 0px 30px 30px;">

                            <div class="stat clearfix">
                                <h3>

                                    <a href="/portal/search">

                                        <span id="rcount">---</span>
                                        <br>Specimen Records</a>
                                </h3>
                            </div>

                            <div class="stat cleafix">
                                <h3>
                                    <a href="/portal/search?hasImage=true">

                                        <span id="mrcount">---</span>
                                        <br>Media Records</a>
                                </h3>
                            </div>
                            <div class="stat clearfix">
                                <h3>
                                    <a href="/portal/publishers">
                                        <span id="rscount">---</span>
                                        <br>Recordsets
                                    </a>
                                </h3>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>
</div>

{% endblock %} 

{% block scriptblock %}
<script type="text/javascript" src="/portal/components/underscore/underscore.js"></script>

<script>
{% autoescape false %} 
   {{javascript}} 
{% endautoescape %}

contexts = $.map(contexts, function(x, index) {
    return x;
});
</script>

<script type="text/javascript" src="/portal/js/fields.js"></script>

<script type="text/javascript">
var fields = new Fields();
adv_form(contexts, fields);
facets_list(contexts, fields);
</script>
<script type="text/javascript" src="/portal/js/search.js"></script>

<script type="text/javascript">

function runAC(term,callback){
    var terms = ["scientificname","genus","specificepithet","country"];
    var facets = {};
    for(t in terms){
        facets["static_"+terms[t]] = {"terms":{"field": terms[t]}}
    }
    var query = {
      "facets": {
        "static_scientificname": {
          "terms": {
            "field": "scientificname",
            "regex": "..+",
            "order": "term",
            "size": 20
          }
        }
      },
      "from": 0,
      "size": 20,
      "query": {
        "filtered": {
          "query": {
            "match_all": {}
          },
          "filter": {
            "and": [
              {
                "prefix": {
                  "scientificname": term
                },
              }
            ]
          }
        }
      },
      "sort": {
        "scientificname": {
          "order": "asc"
        }
      }
    };
    esQuery('records', query, function(resp) {
        var list = [];
        $.each(resp.facets['static_scientificname']['terms'], function(index, obj) {
            list.push(obj.term);
        })
        callback(list);
    })    
}

$("#searchbox").autocomplete({
    source: function(searchString, respCallback) {
        runAC($("#searchbox").val().toLowerCase(), function(resp) {
            respCallback(resp);
        });
    },
    /*focus: function (event,ui){
        //adaption for textarea input with "or" query
        var input = $(self).val().split('\n');
        if(input.length > 1){
            input.pop();//remove partial line
            ui.item.value = input.join('\n') + '\n' + ui.item.value;
        }    
    },*/
    messages: {
        noResults: '',
        results: function() {}
    }
})
var es;

function displayJSON(data, xhr) {
    if (Object.keys(es.state.searchterms).length > 0) {
        window.location.href = "/portal/search/records?state=" + encodeURIComponent(JSON.stringify(es.state));
    }
};
var labellist = {}, keylist = {};
/*$('#searchbox').typeahead({
    source:function(query,callback){
    
        var sterm = query.toLowerCase();//request.term = request.term.toLowerCase()
        $.each(es.aclist, function(key, fac) {
            var ff = {}
            ff[fac] = sterm;
            es.facets[fac] = {
                terms: {
                    field: fac,
                    regex: "^" + sterm + ".*$"
                },
                facet_filter: {
                    prefix: ff
                }
            };
        });
        es.runSearch(function(data, xhr) {
            var acres = [];

            list = {};
            $.each(data["facets"], function(fkey, fterm) {
                if (!fkey.startsWith("static_")) {
                    $.each(fterm["terms"], function(tkey, tterm) {
                        if (tterm["term"].startsWith(sterm)) {
                            labellist[tterm["term"] + "(" + tterm["count"] + ") - " + fkey ] = {term: tterm["term"], key: fkey};
                            keylist[tterm["term"]] = {label: tterm["term"] + "(" + tterm["count"] + ") - " + fkey , key: fkey}
                            acres.push( tterm["term"] + "(" + tterm["count"] + ") - " + fkey );
                        }
                    });
                }
            });
            
            callback(acres);
        });
    },
    updater: function(item) {
        return labellist[item].term;
    },
})
*/
$('#search-button').on('click',function(event){
    event.preventDefault();
    var val = $('#searchbox').val();
    document.location = '/portal/search?scientificname='+val;//keylist[val].key+'='+val;
})
/*
$("#searchbox").keyup(function(event) {
    var key = (event.keyCode) ? event.keyCode : event.which;
    if (key != null) {
        key = parseInt(key, 10);
        if (key == 13) {
            es.addSearchTerm("_all", $("#searchbox").val())
        }
    }
});
$("#searchbox").autocomplete({
    source: function(request, response) {
        request.term = request.term.toLowerCase()
        $.each(es.aclist, function(key, fac) {
            var ff = {}
            ff[fac] = request.term;
            es.facets[fac] = {
                terms: {
                    field: fac,
                    regex: "^" + request.term + ".*$"
                },
                facet_filter: {
                    prefix: ff
                }
            };
        });
        es.runSearch(function(data, xhr) {
            var acres = [];
            $.each(data["facets"], function(fkey, fterm) {
                if (!fkey.startsWith("static_")) {
                    $.each(fterm["terms"], function(tkey, tterm) {
                        if (tterm["term"].startsWith(request.term)) {
                            acres.push({
                                label: tterm["term"] + "(" + tterm["count"] + ") - " + fkey,
                                value: fkey + ":" + tterm["term"]
                            });
                        }
                    });
                }

            });
            response(acres);
        });
    },
    minLength: 2,
    select: function(event, ui) {
        var iv = ui.item.value.split(':');
        if (es.searchterms[iv[0]]) {
            es.searchterms[iv[0]].push(iv[1]);
        } else {
            es.searchterms[iv[0]] = [iv[1]];
        }
        es.runSearch(displayJSON);
        $(this).val("");
        return false;
    },
    open: function() {
        $(this).removeClass("ui-corner-all").addClass("ui-corner-top");
    },
    close: function() {
        $(this).removeClass("ui-corner-top").addClass("ui-corner-all");
    }
});

*/


/*$(function() {
    es = new ESManager(window.searchServer, searchcfg.index, searchcfg.base_fields);
    es.limit = 10;
    es.runSearch(displayJSON);
});*/
</script>

<script type="text/javascript">

function formatNum(num){
    return num.toString().replace(/,/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

$(document).ready(function() {
    var searchurl = ((searchServer['port'] == 443 || searchServer['port'] == '443') ? 'https://' : 'http://') + searchServer['host'];//((window.searchServer.port === 80 ? 'http://' : 'https://') + window.searchServer.host);
   
    $.getJSON(searchurl + "/idigbio/recordsets/_count", function(data) {
        $("#rscount").html(formatNum(data.count));
    });
    $.getJSON(searchurl + "/idigbio/mediarecords/_count", function(data) {
        $("#mrcount").html(formatNum(data.count));
    });
    $.getJSON(searchurl + "/idigbio/records/_count", function(data) {
        $("#rcount").html(formatNum(data.count));
    });
});
</script>
<script src="/portal/components/highcharts/highcharts.js"></script>
<script src="/portal/components/highcharts/modules/exporting.js"></script>

<script>
var colors = [
    '#2f7ed8',
    '#0d233a',
    '#8bbc21',
    '#910000',
    '#1aadce',
    '#492970',
    '#f28f43',
    '#77a1e5',
    '#c42525',
    '#a6c96a'
]


var jsondata = {"0072bf11-a354-4998-8730-c0cb4cfc9517":"plants","00d9fcc1-c8e2-4ef6-be64-9994ca6a32c3":"plants","02fceae6-c71c-4db9-8b2f-e235ced6624a":"fungi","04d9b721-259c-4d6b-b48f-2e23edf66c9f":"fungi","063825dc-b8c3-4962-aea4-9994bcc09bc8":"plants","0bada388-4adf-4b8c-b733-0a1bfc7c233c":"plants","0c15e83e-79ee-4ee3-86e3-e5f98a51dc11":"fungi","0dd7c8dd-412c-4a13-a1d3-47e1e1af5455":"plants","0e0e9bbc-1dea-4de4-95ae-aecc90844bbf":"plants","0fcbf959-b714-4ba2-8152-0c1440e31323":"plants","10a02814-9469-42fd-b074-22ca6c8271c7":"fungi","14a8f79f-eab7-48da-ad50-bda142703820":"vertebrates","15aa4812-aad2-4b26-a1d8-d4f8d79e6163":"fungi","17cea35c-721f-4d9b-b67f-d29250064d25":"plants","181352ea-3598-4f32-b919-c8f6097f4c65":"plants","1a8eea37-7c72-4032-a38a-254154449ad1":"plants","1bb33d2d-0714-4fc9-968e-b66bab1cf3d3":"plants","1c8ec291-8067-4b48-848b-410c2c768420":"plants","1da2a87d-4fc7-4233-b127-59cb8d1ca5ee":"plants","1eca069b-09e0-406d-9625-cb9c52e1e5cc":"fungi","1f2b44b8-8556-4d6e-8247-4611689551cf":"fungi","215eeaf0-0a88-409e-a75d-aec98b7c41eb":"plants","26f7cbde-fbcb-4500-80a9-a99daa0ead9d":"plants","271a9ce9-c6d3-4b63-a722-cb0adc48863f":null,"29d217e3-754b-4a72-9e57-5cd05312e7c0":"plants","2bbafa00-3162-4e8e-947c-64a13b8d3fef":"plants","2eb8ff2f-4826-4fc3-be68-22d805bcae88":"plants","314f66a9-2b8f-4085-b10c-0f083ce2f1eb":"plants","31c140bc-e6f1-4acc-beaf-b825cf288ad9":"arthropods","333ac26a-30bc-4e0c-a6ef-c57a40f6bd99":"plants","33fd0737-6207-42cc-bc64-cc637266b476":"plants","35c43eda-1f4a-4713-bb69-e3fbe1bf792f":"plants","35ff9d4c-829f-42c9-b8ab-8dbe1a69e0d7":"arthropods","37d4d085-d8be-4826-9bc4-c6a36557fa70":"fungi","3b9ecf1e-3c04-4d8b-84cd-9ae48e70e13a":"vertebrates","3f508496-c860-4701-93e4-84e940c8395e":"plants","3feab0ae-cfc3-40fb-b681-018c410f1996":"fungi","40250f4d-7aa6-4fcc-ac38-2868fa4846bd":"plants","40987883-03cf-494a-a5cf-7c77c7aadb79":"plants","41350373-fc6f-4dd9-b908-27805fff9155":"plants","46374ee7-7c70-48d8-bf16-2e6c1626565e":"fungi","4830ffb8-669a-4717-bec8-2f2374f52120":"plants","48e1b8c1-91aa-4b87-8ca0-de1f81232eaf":"vertebrates","49db9725-7bdc-4c38-8548-c32994e811c1":"plants","4b92de1f-866d-4b82-af69-37d46753f289":"plants","4dce41dc-2af6-448c-99e1-abfd3a9cc3e5":"plants","51b958bb-9d5f-48d7-9a97-e372c0c747c3":"vertebrates","5835f642-2560-4e3e-9c25-741a12cc3fe8":"plants","58402fe3-37c1-4d15-9e07-0ff1c4c9fb11":"plants","5a0d649f-a64f-4e20-a37c-2fe7f9e37bad":"plants","5aac25d2-bcfb-4084-a700-584311ea539d":"arthropods","5e893602-84ca-4c8c-bac1-99111c777582":"arthropods","5eb57cb9-a6e8-4f84-abde-41a6bfd2080b":"arthropods","62254613-2696-4834-8c58-5c465f70df56":"plants","62f951c1-b6a8-430c-8652-5691f079152c":"plants","645bcd10-a74f-4207-a375-0254b954b7ad":"plants","6539877e-82dc-485c-ad3d-038f383d5431":"arthropods","69037495-438d-4dba-bf0f-4878073766f1":"arthropods","6ac89a16-4604-4a78-9047-dcc57e5c0130":"plants","6aca6f67-a2e9-440d-a503-9501db6e6f36":"plants","6b565194-9707-42da-8052-9f9cf5f9aa60":"plants","6bb853ab-e8ea-43b1-bd83-47318fc4c345":"non-arthropod invertebrates","7110b8ba-0ead-4666-8279-e30f53e343d0":"plants","7340c0df-8829-4197-9dc7-0328b8e7f5dd":"fungi","7450a9e3-ef95-4f9e-8260-09b498d2c5e6":"plants","7559ca29-1d2f-4a64-993f-41939ee40947":"fungi","77b762ba-7cda-4617-97d7-e78df7f6dfab":"plants","7809d96b-7edf-4ef7-9f12-59967e9a01a6":"plants","79be41bc-8142-485a-9d57-d6195f9a7c81":"fungi","7ad07cff-f782-4ddf-b780-3a757cdb77e0":"fungi","7c927849-94ed-4034-90e9-af34ac0cb47c":"plants","7fcdca8e-7469-480c-8516-cce4e24c37c9":"arthropods","821c1855-6817-40ee-8732-7f472d238513":"plants","82541f90-fe8e-4d66-84d8-4fe515dc5533":"arthropods","84006c59-fead-4b84-b3b5-cedf28f67ea9":"arthropods","8445ab25-ff89-44b0-90f8-bf0790f50afc":"plants","87c45c90-ba1d-409e-a9d7-9baf5a5cbb1c":"arthropods","87fee729-2a4e-4d23-ad8a-5e03e1ab7c1a":"vertebrates","89eb1ad0-ae60-4e8a-bf34-a53d0423bc80":"plants","8e5fffb5-0b22-472d-8386-de291d17d513":"plants","91a0a18a-3196-4f87-87b6-02c7f8a12996":"fungi","91c5eec8-0cdc-4be2-9a99-a15ae5ec3edc":"fungi","92dd8c8e-c048-4f0a-9b5d-2ee627d2f553":"arthropods","9368e302-f8e7-4714-aed4-db2faa861e5c":"plants","95773ebb-2f5f-43f0-a652-bfd8d5f4707a":"arthropods","95ecb448-3c1f-4145-8565-4f6d51beb62c":"fossils","9756b9a4-c070-4359-8a07-2383b09d0d04":"plants","995cc7f1-69c3-4317-ab77-28fd48f1e535":"plants","99b04c9f-908e-42bd-92bc-41aa94b72949":"plants","9ace4c05-d930-45c7-8d2d-0cadff1ea32b":"arthropods","9bd4ff72-1cb2-431f-bf7b-b5d47e08cc02":"arthropods","9c963109-9898-4953-a351-d5ee36d6115b":"plants","9d2a4189-6048-46e9-bac4-e5ef566334bb":"plants","a3b77120-3770-46dd-ba47-6941eff848b3":"arthropods","a6743a43-b86a-4265-9521-fad3a24461a6":"plants","ab4b6a2b-a90a-44ce-95a1-2c44c911fcc6":"arthropods","ab820732-0844-4323-ba14-c58c24f3fc7e":"plants","abe3903e-ceba-4864-aa5d-bd985c70fa21":"plants","b000920c-6f7d-49d3-9d0f-2bb630d2e01a":"fungi","b12b08da-3d05-4406-a051-0139a33ecf35":"plants","b1c7a275-21f6-4b66-895d-d497359b34a1":"plants","b3f10d7b-6763-4f79-9789-f6abc68b9720":"plants","b531ea59-025d-4c29-9d23-99ae75bcd55f":"plants","b5d8168e-c310-4870-aa88-eeb3c25256fd":"vertebrates","b5e5c781-765f-4981-af2a-c19c250e2cf0":"plants","b62cf6c0-e046-4c3f-9765-d0e046072b0f":"plants","b7349341-c8e2-4628-be5f-77600ba730fa":"plants","b8972f6b-c67f-45c0-b348-954866e04a0f":"plants","b8cbed64-5126-46bd-97aa-43627743aba7":"vertebrates","bbf5f8ed-f33f-40ba-9d0d-1c24dfec4193":"plants","bd61c458-b865-4b05-9f1f-735c49066e55":"non-arthropod invertebrates","bd7cfd55-bf55-46fc-878d-e6e11f574ccd":"vertebrates","bdf65f9c-a730-4083-bd8d-a2def3037637":"plants","beb74dc2-22ea-49e4-b1e3-bedb8e06e8f2":"vertebrates","beecd160-a96c-46fc-bdce-7dcb7024d473":"fungi","c0bb93c7-5906-43be-a2af-7f61078d5d7e":"plants","c38b867b-05f3-4733-802e-d8d2d3324f84":"vertebrates","c3a7b339-122e-4fe9-8851-371b1fdf584e":"plants","c481fbc6-4bd7-4c50-8537-ba1993d4eb88":"plants","c569e530-7322-40b8-9b66-1e0ed96fefcb":"plants","c5d42fed-eed0-4e14-9625-f8a9c0ff6bb1":"plants","c6e89321-fc23-4cba-ad79-be3e52edfb6d":"plants","caaa464d-e290-4761-8550-75edc6d00119":"plants","cb2e732c-20a8-4037-9ab0-67a59faeafb8":"plants","cc75bd05-251f-4cbb-afed-100cac9d7aa0":"vertebrates","ccba425a-25e0-4d94-8fde-3890be03ae1b":"plants","cd177f63-761b-44f6-866e-ee19d2ac134e":"plants","ce02a047-625d-4017-aeef-2c34e53824c8":"plants","ced8c9bc-e8b5-49e7-860a-289fc913860c":"plants","cf641fbf-fa31-481a-993b-9204f2ee1884":"fungi","d29b9265-07e6-4e73-8f72-fc42d3d83fb1":"plants","d2c71720-e156-4943-8182-0a7bbe477a37":"plants","d6c6e57a-4ccb-4707-b87d-c91d01d6aa42":"plants","d70edfe9-c358-4bf3-96d2-22fddc702994":"vertebrates","d767f759-af64-4464-8614-c77ca44cad8d":"arthropods","d78c4f23-f6c4-42cd-8ddf-d5a98c351545":"vertebrates","da1ef9b1-761b-4bc3-8ac0-b9a109101f5f":"vertebrates","db4bb0df-8539-4617-ab5f-eb118aa3126b":"arthropods","ded380b5-1ba2-4089-8e0c-0aa1b4140785":"arthropods","df516dc6-6ef0-426d-94e3-8a2bbb0439a5":"plants","dfd53a42-8f63-4040-93a5-3f1347ce7686":"plants","e0e37702-32af-405b-b652-ee54b5bb94e2":"plants","e39f6dee-f2cf-4eff-afc9-4600cafe660c":"plants","e7ac8c4a-64bd-491b-b764-232de9b4bfe5":"fungi","e812c193-89b5-4da8-980d-e759ac50ffba":"plants","e881a3e2-f7ba-43c8-ae9a-11fcbfd741bb":"plants","e95396c4-1cac-4c9b-b461-5f21cd978fc6":"fungi","ec248223-f277-4c02-b1fa-60056b5a689a":"fungi","ec4289d8-1114-43b9-9f04-ad809aa1dbe3":"fungi","ef04e127-bb7d-4bf0-82d3-767d43108f81":"plants","ef30a918-b583-41f1-9ac4-4a37591b515a":"arthropods","ef637c01-c551-4d47-8a48-4442b8ad5ecd":"plants","efc8b829-65b0-4fff-b6b2-f1148c68f80d":"vertebrates","f1a78c0f-449c-45fa-9472-0b92cc2a58da":"plants","f33e9494-7b3c-4ac6-a735-59693b5a9638":"plants","f3a5ec1a-49dd-4a52-8bd8-67cacae7a7ac":"plants","f4214a7a-6793-48e0-ac41-9baff83096d3":"plants","f6298100-86ae-458f-9fb1-bbb3bb325422":"fungi","f83517ea-7b9f-443d-9371-d11a05ebc0a7":"arthropods","fc40fabd-0a70-48fa-b142-79990cd259a5":"plants","fc628e53-5fdf-4436-9782-bf637d812b48":"arthropods","fccc3c1d-d9df-4ffd-b7e1-1b9eb11f95b1":"plants","fd14095c-3658-4e00-8cec-729a89459e92":"plants","fdf7bb59-aad2-4f10-879f-6c0e7d3baa64":"fungi","ff0d1543-247c-4039-a8ff-cf4fc224c449":"fungi","ff111763-e72d-4f24-8914-b5b2dd94908c":"arthropods"}

/*var data = {
    "Plants": {
        "count": 26,
        "record_count": 1091703,
        "media_count": 133993
    },
    "Amphibians and Reptiles": {
        "count": 1,
        "record_count": 165722,
        "media_count": 0
    },
    "Mammals": {
        "count": 2,
        "record_count": 32264,
        "media_count": 0
    },
    "Fungi": {
        "count": 31,
        "record_count": 769775,
        "media_count": 210380
    },
    "Fishes": {
        "count": 2,
        "record_count": 321438,
        "media_count": 0
    },
    "Arthropods": {
        "count": 15,
        "record_count": 349480,
        "media_count": 10430
    },
    "Invertebrates": {
        "count": 1,
        "record_count": 513377,
        "media_count": 0
    },
    "Mixed": {
        "count": 1,
        "record_count": 0,
        "media_count": 0
    },
    "Birds": {
        "count": 1,
        "record_count": 0,
        "media_count": 0
    }
}
*/
var facetquery = {
  "query": {
    "bool": {
      "must": [
        {
          "match_all": {}
        }
      ],
      "must_not": [],
      "should": []
    }
  },
  "from": 0,
  "size": 1,
  "sort": [],
  "facets": {
    "rsfacet": {
      "terms": {
        "field": "recordset",
        "size": 1000
      }
    }
  }
}
var searchBase = "//" + window.searchServer["host"] + "/idigbio/";
var data = {};
var rcomplete=false;
$.post(searchBase + "records/_search",JSON.stringify(facetquery),function(resp,textStatus,jqXHR){
    var terms = resp.facets.rsfacet.terms;
    $.each(terms,function(ind,obj){

        var type;
        if(typeof jsondata[obj.term] === 'undefined' || jsondata[obj.term] === null){
            type = "Other";
        }else{
            type = jsondata[obj.term].charAt(0).toUpperCase() + jsondata[obj.term].slice(1);
        } 
        
        if(typeof data[type] === 'undefined'){
            data[type]={
                "count": 0,
                "record_count": 0,
                "media_count": 0
            }
        }
        data[type]["record_count"] += obj.count;
        data[type]["count"]++;
    });
    rcomplete=true;
    render();
});

var mcomplete=false;
$.post(searchBase + "mediarecords/_search",JSON.stringify(facetquery),function(resp,textStatus,jqXHR){
    var terms = resp.facets.rsfacet.terms;
    $.each(terms,function(ind,obj){

        var type;
        if(typeof jsondata[obj.term] === 'undefined' || jsondata[obj.term] === null){
            type = "Other";
        }else{
            type = jsondata[obj.term].charAt(0).toUpperCase() + jsondata[obj.term].slice(1);
        } 
        
        if(typeof data[type] === 'undefined'){
            data[type]={
                "count": 0,
                "record_count": 0,
                "media_count": 0
            }
        }
        data[type]["media_count"] += obj.count;
    });
    mcomplete=true;
    render();
});


function render(){

    if(rcomplete && mcomplete){

        var dk = Object.keys(data);
        for (var i = 0; i < dk.length; i++) {
            data[dk[i]]["color"] = colors[i % colors.length];
        }

        $(function() {
            var count_data = [];
            var count_colors = [];
            var record_data = [];
            var record_colors = [];
            var media_data = [];
            var media_colors = [];
            var total_records = 0;
            var total_media = 0;
            _.each(data, function(value, key) {
                if (value.count > 0) {
                    count_data.push([key, value.count])
                    count_colors.push(data[key]["color"])
                }
                if (value.record_count > 0) {
                    record_data.push([key, value.record_count])
                    record_colors.push(data[key]["color"])
                    total_records += value.record_count;
                }
                if (value.media_count > 0) {
                    media_data.push([key, value.media_count])
                    media_colors.push(data[key]["color"])
                    total_media += value.media_count;
                }
            });

            var rchart = new Highcharts.Chart({
                chart: {
                    renderTo: 'record',
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false
                },
                title: {
                    text: ''
                },
                tooltip: {
                    formatter: function() {
                        return this.point.name + ': <b>' + this.point.y + '</b>';
                    }
                },
                colors: record_colors,
                legend: {
                    enabled: true,
                    labelFormatter: function() {
                        var pct = 0.0
                        if (this.percentage) {
                            pct = this.percentage;
                        }
                        return '<b>' + this.name + '</b>: ' + pct.toFixed(2) + ' %';
                    }
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: false,
                            color: '#000000',
                            connectorColor: '#000000',
                            formatter: function() {
                                return '<b>' + this.point.name + '</b>: ' + this.percentage.toFixed(2) + ' %';
                            }
                        },
                        showInLegend: true
                    }
                },
                series: [{
                    type: 'pie',
                    name: 'Record share',
                    data: record_data
                }]
            });
            $.each(rchart.series[0].points, function(point) {
                delete rchart.series[0].points[point].legendItem;
            });
            rchart.legend.destroy();
            rchart.legend.render();

            var mchart = new Highcharts.Chart({
                chart: {
                    renderTo: 'media',
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false
                },
                title: {
                    text: ''
                },
                tooltip: {
                    formatter: function() {
                        return this.point.name + ': <b>' + this.point.y + '</b>';
                    }
                },
                colors: media_colors,
                legend: {
                    enabled: true,
                    labelFormatter: function() {
                        var pct = 0.0
                        if (this.percentage) {
                            pct = this.percentage;
                        }
                        return '<b>' + this.name + '</b>: ' + pct.toFixed(2) + ' %';
                    }
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: false,
                            color: '#000000',
                            connectorColor: '#000000',
                            formatter: function() {
                                return '<b>' + this.point.name + '</b>: ' + this.percentage.toFixed(2) + ' %';
                            }
                        },
                        showInLegend: true
                    }
                },
                series: [{
                    type: 'pie',
                    name: 'Media share',
                    data: media_data
                }]
            });
            $.each(mchart.series[0].points, function(point) {
                delete mchart.series[0].points[point].legendItem;
            });
            mchart.legend.destroy();
            mchart.legend.render();
        });

    }
}



</script>
{% endblock %}